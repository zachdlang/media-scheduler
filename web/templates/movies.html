{% extends 'base.html' %}

{% macro gen_movie(m) -%}
	<div class="movie col-xs-12 col-sm-12 col-md-4 col-lg-4" data-movieid="{{ m.id }}">
		<div class="inner-movie well col-xs-12 col-sm-12 col-md-12 col-lg-12">
			<img class="poster img-responsive col-xs-4 col-sm-4 col-md-4 col-lg-4" src="{{ m.poster }}" alt="Poster for {{ m.name }}">
			<div class="movie-content col-xs-8 col-sm-8 col-md-8 col-lg-8">
				<h5>{{ m.name }} <small>{{ m.releasedate_str }}</small></h5>
				<a class="btn btn-success btn-block watched_movie"><span class="glyphicon glyphicon-ok"></span> Watched</a>
			</div>
		</div>
	</div>
{%- endmacro %}

{% block content %}
<div class="heading col-xs-12 col-sm-12 col-md-12 col-lg-12">
	<h4>
		Movies ({{ movies | length }})
		<button type="button" class="btn btn-primary pull-right" data-toggle="modal" data-target="#followModal"><span class="glyphicon glyphicon-plus"></span> Add New Movie</button>
	</h4>
</div>

{% if outstanding %}
	<div class="date col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<h4>Outstanding</h4>
		{% for m in movies if m.in_past %}
			{{ gen_movie(m) }}
		{% endfor %}
	</div>
{% endif %}

{% for d in dates %}
	<div class="date col-xs-12 col-sm-12 col-md-12 col-lg-12">
		<h4>{{ d }}</h4>
		{% for m in movies if m.releasedate_str == d %}
			{{ gen_movie(m) }}
		{% endfor %}
	</div>
{% endfor %}

<div id="followModal" class="modal fade" role="dialog">
	<div class="modal-dialog">
		<div class="modal-content col-xs-12 col-sm-12 col-md-12 col-lg-12">
			<div class="modal-header col-xs-12 col-sm-12 col-md-12 col-lg-12">
				<button type="button" class="close" data-dismiss="modal">&times;</button>
				<h4 class="modal-title">Add New Movie</h4>
			</div>
			<div class="modal-body col-xs-12 col-sm-12 col-md-12 col-lg-12">
				<div id="modal_flash_div"></div>
				<div class="form-group">
					<div class="input-group col-xs-12 col-sm-12 col-md-12 col-lg-12">
						<input type="text" class="form-control" id="follow_search">
						<a class="btn btn-primary input-group-addon" id="follow_search_submit">Search</a>
					</div>
				</div>

				<div id="follow_search_result" class="hidden"></div>
			</div>
			<div class="modal-footer col-xs-12 col-sm-12 col-md-12 col-lg-12">
				<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block script %}
<script>
	$('.watched_movie').on('click', function() {
		var row = $(this).closest('.movie');
		$.ajax({
			url: "{{ url_for('schedule.movies_watched') }}",
			method: "POST",
			data: { 'movieid':row.data()['movieid'] }
		}).done(function(data) {
			if (data.error) {
				show_flash(data.error, 'danger');
			} else {
				row.remove();
				$('.date').each(function() {
					if ($(this).find('.movie').length <= 0) $(this).remove();
				});
			}
		}).fail(function() {
			handle_internal_error();
		});
	});

	$('#followModal').on('shown.bs.modal', function() {
		$('#follow_search').focus();
	});

	$('#followModal').on('hidden.bs.modal', function() {
		$('#follow_search').val('');
		$('#follow_search_result').addClass('hidden').empty();
	});

	$('#follow_search_submit').on('click', function() {
		follow_search();
	});

	$('#follow_search').on('keyup', function(e) {
		if (e.keyCode == 13) follow_search();
	});

	function follow_search() {
		if ($('#follow_search').val()) {
			$.ajax({
				url: "{{ url_for('schedule.movies_search') }}",
				method: "GET",
				data: { 'search':$('#follow_search').val() }
			}).done(function(data) {
				if (data.error) {
					show_flash(data.error, 'danger');
				} else {
					var m_html = '';
					for (var i=0; i < data.result.length; i++) {
						var m = data.result[i];
						m_html += '<div class="search-result col-xs-12 col-sm-6 col-md-6 col-lg-6" data-moviedb_id="'+m.id+'" data-name="'+m.name+'" data-releasedate="'+m.releasedate+'">\
										<div class="inner-search well well-sm col-xs-12 col-sm-12 col-md-12 col-lg-12">';
						if (m.poster) m_html += '<img class="img-responsive" src="https://image.tmdb.org/t/p/w640'+m.poster+'">';
						m_html += '<h5>'+m.name;
						if (m.year) m_html += ' ('+m.year+')';
						m_html += '</h5>\
								</div>\
							</div>';
					}
					$('#follow_search_result').removeClass('hidden').html(m_html);
				}
			}).fail(function() {
				handle_internal_error();
			});
		}
	}

	$('#follow_search_result').on('click', '.search-result .inner-search', function() {
		var row = $(this).closest('.search-result');
		$.ajax({
			url: "{{ url_for('schedule.movies_follow') }}",
			method: "POST",
			data: { 'moviedb_id':row.data()['moviedb_id'], 'name':row.data()['name'], 'releasedate':row.data()['releasedate'] }
		}).done(function(data) {
			if (data.error) {
				show_flash(data.error, 'danger');
			} else {
				show_flash('Successfully added.', 'success');
				$('#follow_search').val('').focus();
			}
		}).fail(function() {
			handle_internal_error();
		});
	});
</script>
{% endblock %}